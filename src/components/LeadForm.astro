---
interface Props {
  headline?: string;
  description?: string;
  deferDisplay?: boolean;
  eyebrow?: string;
  formId?: string;
  showFloatingCta?: boolean;
  isGlobalFallback?: boolean;
}

const {
  headline = "Đánh giá mức phù hợp Hòa Lạc",
  description = "Trả lời 5 câu để đội ngũ gợi ý khu vực, pháp lý và room tài chính khớp với nhu cầu trong 24 giờ.",
  deferDisplay = true,
  eyebrow = "Lead Qualification",
  formId = "lead-form",
  showFloatingCta = true,
  isGlobalFallback = false,
} = Astro.props;

const defaultLeadTag = import.meta.env.PUBLIC_DEFAULT_LEAD_TAG ?? "pending_classification";
const leadEndpoint = import.meta.env.PUBLIC_LEAD_ENDPOINT ?? "";

const intentOptions = [
  { value: "o_thuc", label: "Ở thật" },
  { value: "dau_tu_trung_han", label: "Đầu tư trung hạn" },
  { value: "luot_song", label: "Lướt sóng" }
];

const budgetOptions = [
  { value: "<1.5", label: "< 1,5 tỷ" },
  { value: "1.5-2.5", label: "1,5 – 2,5 tỷ" },
  { value: "2.5-3.5", label: "2,5 – 3,5 tỷ" },
  { value: ">3.5", label: "> 3,5 tỷ" }
];

const areaOptions = [
  { value: "gan_dhqg", label: "Gần ĐHQG" },
  { value: "gan_cnc", label: "Gần khu CNC" },
  { value: "binh_yen_thach_hoa", label: "Bình Yên – Thạch Hòa" },
  { value: "tien_xuan_yen_binh", label: "Tiến Xuân – Yên Bình" },
  { value: "hoa_lac_trung_tam", label: "Trung tâm Hòa Lạc" },
  { value: "khu_tay_bac", label: "Cụm Tây Bắc" }
];

const legalOptions = [
  {
    value: "so_do_san",
    label: "Chỉ sổ đỏ",
    hint: "Nhận đất ở ngay, pháp lý chuẩn"
  },
  {
    value: "cho_len_tho_cu",
    label: "Chờ lên thổ cư",
    hint: "Chấp nhận 6–12 tháng làm thủ tục"
  },
  {
    value: "co_the_rui_ro",
    label: "Có thể rủi ro",
    hint: "Chấp nhận đất vườn, quy hoạch chờ"
  }
];
---
<section
  id={formId}
  class:list={["section-shell", "section-shell--lead", isGlobalFallback && "lead-shell--portal"]}
  data-lead-shell
  data-defer={String(deferDisplay)}
  data-endpoint={leadEndpoint}
  data-global={String(isGlobalFallback)}
  data-force-modal={String(isGlobalFallback)}
  data-floating-enabled={String(showFloatingCta)}
>
  <div class="lead-modal-overlay" data-lead-overlay aria-hidden="true"></div>
  <div class="shell-inner lead-shell">
    <div class="lead-card">
      <div class="lead-copy">
        <p class="tag">{eyebrow}</p>
        <h2>{headline}</h2>
        <p>{description}</p>
      </div>
      <form class="lead-form" data-lead-form novalidate>
        <button class="lead-form__close" type="button" data-lead-close aria-label="Đóng form">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
          </svg>
        </button>
        <fieldset class="field" data-field-group="intent">
          <legend>Anh/chị quan tâm đất Hòa Lạc để:</legend>
          <div class="option-grid">
            {intentOptions.map((option) => (
              <label class="option">
                <input type="radio" name="intent" value={option.value} required />
                <div class="option-text">
                  <span>{option.label}</span>
                </div>
              </label>
            ))}
          </div>
        </fieldset>
        <p class="field-error" data-error-for="intent" role="status" aria-live="polite"></p>
        <fieldset class="field" data-field-group="budgetRange">
          <legend>Tầm tài chính:</legend>
          <div class="option-grid">
            {budgetOptions.map((option) => (
              <label class="option">
                <input type="radio" name="budgetRange" value={option.value} required />
                <div class="option-text">
                  <span>{option.label}</span>
                </div>
              </label>
            ))}
          </div>
        </fieldset>
        <p class="field-error" data-error-for="budgetRange" role="status" aria-live="polite"></p>
        <fieldset class="field" data-field-group="areas">
          <legend>Khu vực ưu tiên:</legend>
          <p class="hint">Chọn tối đa 2 khu vực (nếu cần).</p>
          <div class="option-grid">
            {areaOptions.map((option) => (
              <label class="option">
                <input type="checkbox" name="areas" value={option.value} />
                <div class="option-text">
                  <span>{option.label}</span>
                </div>
              </label>
            ))}
          </div>
        </fieldset>
        <p class="field-error" data-error-for="areas" role="status" aria-live="polite"></p>
        <fieldset class="field" data-field-group="legalRisk">
          <legend>Mức chấp nhận pháp lý:</legend>
          <div class="option-grid option-grid--legal">
            {legalOptions.map((option) => (
              <label class="option">
                <input type="radio" name="legalRisk" value={option.value} required />
                <div class="option-text">
                  <span>{option.label}</span>
                  <small>{option.hint}</small>
                </div>
              </label>
            ))}
          </div>
        </fieldset>
        <p class="field-error" data-error-for="legalRisk" role="status" aria-live="polite"></p>
        <div class="field" data-field-group="contact">
          <label>Để lại Zalo / SĐT</label>
          <input
            type="tel"
            name="contact"
            required
            inputmode="tel"
            pattern="^(03|05|07|08|09|01[2689])[0-9]{8}$"
            placeholder="Zalo hoặc số điện thoại"
          />
          <p class="field-error" data-error-for="contact" role="status" aria-live="polite"></p>
        </div>
        <input type="hidden" name="source" value={isGlobalFallback ? "lead-portal" : "lead-inline"} />
        <input type="hidden" name="leadTag" value={defaultLeadTag} data-lead-tag />
        <input type="text" name="company" class="hp" tabindex="-1" autocomplete="off" />
        <button class="button" type="submit">Gửi yêu cầu</button>
        <p class="status" data-status role="status" aria-live="polite"></p>
      </form>
    </div>
  </div>
  {showFloatingCta && (
    <button class="floating-cta" type="button" data-floating-cta aria-hidden="true">
      <span>Đánh giá mức phù hợp</span>
      <small>Trả lời 5 câu, nhận shortlist trong 24h</small>
    </button>
  )}
</section>

<style>
  .section-shell--lead {
    padding-block: clamp(1.5rem, 4vw, 3rem);
    padding-inline: clamp(1.25rem, 5vw, 2.75rem);
  }
  .lead-shell--portal {
    display: none;
    padding: 0;
  }
  .lead-shell--portal.is-modal-open {
    display: block;
  }
  .lead-shell {
    max-width: 960px;
    margin: 0 auto;
  }
  .lead-card {
    position: relative;
    background: #fff;
    border-radius: 1.75rem;
    padding: clamp(1.25rem, 3.5vw, 2.5rem) clamp(1.25rem, 4vw, 2.75rem);
    box-shadow: 0 35px 80px rgba(15, 23, 42, 0.18);
    overflow: hidden;
    color: #0f172a;
    scroll-margin-top: 5rem;
  }
  .lead-card::before {
    content: "";
    position: absolute;
    top: -40%;
    right: -30%;
    width: 360px;
    height: 360px;
    background: radial-gradient(circle, rgba(249, 115, 22, 0.18), transparent 60%);
    pointer-events: none;
    z-index: 0;
  }
  .lead-copy {
    text-align: center;
    max-width: 640px;
    margin: 0 auto 2rem;
    position: relative;
    z-index: 1;
  }
  .lead-copy .tag {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.35rem 0.9rem;
    border-radius: 999px;
    font-size: 0.85rem;
    background: rgba(15, 23, 42, 0.08);
    color: #0f172a;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  .lead-copy h2 {
    margin: 1rem 0 0.5rem;
    font-size: clamp(2rem, 4vw, 2.8rem);
  }
  .lead-copy p {
    margin: 0;
    color: var(--muted);
  }
  .lead-form {
    position: relative;
    background: #fff;
    border-radius: 1.5rem;
    padding: clamp(1.5rem, 4vw, 2.25rem);
    display: grid;
    gap: 1.25rem;
    z-index: 1;
    color: #0f172a;
    width: 100%;
    min-width: 0;
  }
  .lead-form fieldset {
    border: 1px solid rgba(15, 23, 42, 0.12);
    border-radius: 1rem;
    padding: 1rem 1.25rem;
    margin: 0;
    width: 100%;
    min-width: 0;
  }
  .lead-form legend {
    font-weight: 600;
    margin-bottom: 0.65rem;
  }
  .field {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .option-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 0.75rem;
    width: 100%;
    min-width: 0;
  }
  .option-grid--legal {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }
  .option {
    border: 1px solid rgba(15, 23, 42, 0.16);
    border-radius: 0.9rem;
    padding: 0.85rem 1rem;
    display: flex;
    gap: 0.65rem;
    cursor: pointer;
    background: #fff;
    transition: border-color 140ms ease, box-shadow 140ms ease;
  }
  .option input {
    margin-top: 0.15rem;
  }
  .option-text {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  .option-text span {
    font-weight: 600;
  }
  .option-text small {
    font-size: 0.85rem;
    color: var(--muted);
  }
  .option:has(input:checked) {
    border-color: rgba(249, 115, 22, 0.6);
    box-shadow: 0 10px 25px rgba(249, 115, 22, 0.15);
  }
  .hint {
    margin: 0 0 0.35rem;
    font-size: 0.9rem;
    color: var(--muted);
  }
  .field-error {
    margin: 0.1rem 0 0.75rem;
    font-size: 0.85rem;
    color: #dc2626;
    min-height: 1rem;
    transition: opacity 150ms ease;
  }
  .field-error[hidden] {
    opacity: 0;
    height: 0;
    margin: 0;
  }
  fieldset.field.is-invalid {
    border-color: rgba(216, 94, 38, 1);
    box-shadow: 0 0 0 1px rgba(220, 38, 38, 0.2);
  }
  fieldset.field.is-invalid legend {
    color: rgba(216, 94, 38, 1);
  }
  .lead-form input,
  .lead-form select,
  .lead-form textarea {
    border-radius: 0.9rem;
    border: 1px solid rgba(15, 23, 42, 0.16);
    padding: 0.9rem 1rem;
    font-size: 1rem;
    font-family: inherit;
  }
  .lead-form .hp {
    display: none;
  }
  .lead-form__close {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 50%;
    border: none;
    background: rgba(15, 23, 42, 0.08);
    color: #0f172a;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 160ms ease, transform 160ms ease;
    z-index: 2;
    opacity: 0;
    pointer-events: none;
  }
  .lead-form__close:hover {
    background: rgba(15, 23, 42, 0.18);
    transform: translateY(-1px);
  }
  .lead-form__close svg {
    width: 1.1rem;
    height: 1.1rem;
  }
  .status {
    min-height: 1.2rem;
    color: #475569;
    font-size: 0.9rem;
    transition: color 150ms ease;
  }
  .status[data-state="error"] {
    color: #dc2626;
  }
  .status[data-state="success"] {
    color: #15803d;
  }
  .status[data-state="warning"] {
    color: #b45309;
  }
  [data-lead-shell] {
    position: relative;
  }
  [data-lead-shell].is-collapsed .lead-form {
    display: none;
  }
  .floating-cta {
    position: fixed;
    bottom: calc(1.5rem + env(safe-area-inset-bottom, 0px));
    right: 1.5rem;
    background: #f97316;
    color: #fff;
    border: none;
    border-radius: 999px;
    padding: 0.85rem 1.5rem;
    padding-bottom: calc(0.85rem + env(safe-area-inset-bottom, 0px));
    box-shadow: 0 20px 35px rgba(15, 23, 42, 0.25);
    display: none;
    flex-direction: column;
    gap: 0.15rem;
    font-weight: 600;
    cursor: pointer;
    z-index: 50;
    max-width: 260px;
    text-align: left;
    animation: floatPulse 6s ease-in-out infinite;
  }
  .floating-cta small {
    font-size: 0.8rem;
    font-weight: 400;
  }
  [data-lead-shell].cta-visible .floating-cta {
    display: flex;
  }
  [data-lead-shell] .floating-cta[aria-hidden="true"] {
    display: none;
  }
  [data-lead-shell].is-expanded .floating-cta,
  [data-lead-shell].is-modal-open .floating-cta {
    display: none;
  }
  [data-lead-shell].is-modal-open .lead-form__close {
    opacity: 1;
    pointer-events: auto;
  }
  [data-lead-shell].is-modal-open .lead-form {
    position: fixed;
    top: clamp(0.75rem, 6vh, 2.5rem);
    left: 50%;
    transform: translate(-50%, -30px);
    width: min(640px, calc(100vw - 2rem));
    max-width: calc(100vw - 2rem);
    min-width: 0;
    max-height: calc(100vh - 2.5rem);
    overflow-y: auto;
    z-index: 60;
    animation: dropIn 280ms cubic-bezier(0.21, 0.61, 0.35, 1) forwards;
    margin: 0 auto;
  }
  [data-lead-shell].is-modal-open .lead-form::before {
    opacity: 0.9;
  }
  .lead-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.65);
    backdrop-filter: blur(10px);
    opacity: 0;
    pointer-events: none;
    transition: opacity 200ms ease;
    z-index: 50;
  }
  [data-lead-shell].is-modal-open .lead-modal-overlay {
    opacity: 1;
    pointer-events: auto;
  }
  [data-lead-shell].is-modal-open .lead-form::-webkit-scrollbar {
    width: 0.45rem;
  }
  [data-lead-shell].is-modal-open .lead-form::-webkit-scrollbar-thumb {
    background: rgba(15, 23, 42, 0.3);
    border-radius: 999px;
  }
  @media (max-width: 768px) {
    .lead-form {
      padding: 2.2rem 1.5rem 1.75rem;
    }
    .option-grid {
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }
    .floating-cta {
      bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
      right: 1rem;
    }
  }
  @media (max-width: 420px) {
    .option-grid,
    .option-grid--legal {
      grid-template-columns: 1fr;
    }
  }
  @keyframes floatPulse {
    0% {
      transform: translate3d(0, 0, 0) scale(0.98);
      opacity: 0.5;
    }
    50% {
      transform: translate3d(2%, -2%, 0) scale(1.05);
      opacity: 1;
    }
    100% {
      transform: translate3d(-1%, 1%, 0) scale(0.98);
      opacity: 0.5;
    }
  }
  @keyframes dropIn {
    0% {
      opacity: 0;
      transform: translate(-50%, -60px);
    }
    100% {
      opacity: 1;
      transform: translate(-50%, 0);
    }
  }
</style>

<script type="module">
  (() => {
    const AREA_LIMIT = 2;
    const SCROLL_THRESHOLD = 0.65;
    const intentWeights = {
      o_thuc: 3,
      dau_tu_trung_han: 2,
      luot_song: 0
    };
    const budgetWeights = {
      '<1.5': 0,
      '1.5-2.5': 1,
      '2.5-3.5': 2,
      '>3.5': 3
    };
    const legalWeights = {
      so_do_san: 3,
      cho_len_tho_cu: 1,
      co_the_rui_ro: 0
    };
    const priorityAreas = ['gan_dhqg', 'gan_cnc'];
    const SECTION_FLOW = ['intent', 'budgetRange', 'areas', 'legalRisk', 'contact'];
    const SECTION_MESSAGES = {
      intent: 'Vui lòng chọn mục đích sử dụng.',
      budgetRange: 'Vui lòng chọn tầm tài chính.',
      areas: 'Vui lòng chọn ít nhất 1 khu vực ưu tiên.',
      legalRisk: 'Vui lòng chọn mức chấp nhận pháp lý.',
      contact: 'Vui lòng nhập số liên hệ hợp lệ.'
    };
    const PHONE_PATTERN = /^(03|05|07|08|09|01[2689])[0-9]{8}$/;

    const initKey = '__hoaLacLeadFormInit__';
    if (window[initKey]) {
      return;
    }

    window[initKey] = true;

    const boot = () => {
      const shells = Array.from(document.querySelectorAll('[data-lead-shell]'));
      shells.forEach((shell) => initLeadShell(shell));
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', boot, { once: true });
    } else {
      boot();
    }

    function initLeadShell(shell) {
      const form = shell.querySelector('[data-lead-form]');
      if (!form) return;

      const status = shell.querySelector('[data-status]');
      const setStatus = createStatusSetter(status);
      const fieldErrors = createFieldErrorRegistry(form);
      const floatingCta = shell.querySelector('button[data-floating-cta]');
      const overlay = shell.querySelector('[data-lead-overlay]');
      const closeControls = Array.from(shell.querySelectorAll('[data-lead-close]'));
      const endpoint = shell.dataset.endpoint ?? '';
      const deferDisplay = shell.dataset.defer === 'true';
      const showFloatingCta = shell.dataset.floatingEnabled !== 'false';
      const isGlobalFallback = shell.dataset.global === 'true';
      const forceModal = shell.dataset.forceModal === 'true';
      const leadTagInput = form.querySelector('[data-lead-tag]');
      const fallbackLeadTag = leadTagInput?.value ?? 'pending_classification';
      let modalQuery;
      let preferModal = forceModal;
      let previousOverflow = '';

      const emitFloatingToggle = (visible) => {
        window.dispatchEvent(new CustomEvent('lead-floating-cta-toggle', {
          detail: { visible }
        }));
      };

      const showFloatingCtaButton = () => {
        if (!floatingCta) return;
        floatingCta.removeAttribute('aria-hidden');
        emitFloatingToggle(true);
      };

      const hideFloatingCtaButton = () => {
        if (!floatingCta) return;
        floatingCta.setAttribute('aria-hidden', 'true');
        emitFloatingToggle(false);
      };

      hideFloatingCtaButton();

      setupValidationListeners(form, fieldErrors, setStatus);
      applySequentialTabIndex(form);
      const sectionFlow = setupSectionFlow(form, fieldErrors);
      form.addEventListener('reset', () => sectionFlow?.reset?.());

      const areaCheckboxes = form.querySelectorAll('input[name="areas"]');
      areaCheckboxes.forEach((checkbox) => {
        checkbox.addEventListener('change', (event) => handleAreaLimit(event, form, setStatus, fieldErrors));
      });

      const intentInputs = form.querySelectorAll('input[name="intent"]');
      intentInputs.forEach((input) => {
        input.addEventListener('change', () => broadcastIntentChange(input.value));
        if (input.checked) {
          broadcastIntentChange(input.value);
        }
      });

      const areaInputs = form.querySelectorAll('input[name="areas"]');
      areaInputs.forEach((input) => {
        input.addEventListener('change', () => broadcastAreasChange(getSelectedAreaLabels(form)));
      });

      const setBodyScrollLock = (locked) => {
        if (typeof document === 'undefined') return;
        if (locked) {
          previousOverflow = document.body.style.overflow;
          document.body.style.overflow = 'hidden';
        } else {
          document.body.style.overflow = previousOverflow;
        }
      };

      const closeModal = () => {
        if (!shell.classList.contains('is-modal-open')) return;
        shell.classList.remove('is-modal-open');
        overlay?.setAttribute('aria-hidden', 'true');
        setBodyScrollLock(false);
        form.reset();
        sectionFlow?.reset();
        if (leadTagInput) {
          leadTagInput.value = fallbackLeadTag;
        }
        setStatus('');
        fieldErrors.clearAll();
        shell.classList.remove('is-expanded');
        if (deferDisplay && showFloatingCta) {
          shell.classList.add('is-collapsed');
          shell.classList.add('cta-visible');
          showFloatingCtaButton();
        }
      };

      const openModal = () => {
        shell.classList.add('is-modal-open');
        shell.classList.add('is-expanded');
        shell.classList.remove('is-collapsed');
        shell.classList.remove('cta-visible');
        hideFloatingCtaButton();
        overlay?.removeAttribute('aria-hidden');
        setBodyScrollLock(true);
        const firstField = form.querySelector('input, select, textarea');
        firstField?.focus({ preventScroll: true });
      };

      const shouldUseModal = () => forceModal || preferModal;

      const updateModalPreference = () => {
        if (typeof window === 'undefined' || !deferDisplay || !showFloatingCta || forceModal) {
          return;
        }
        if (!modalQuery) {
          modalQuery = window.matchMedia('(max-width: 768px)');
          modalQuery.addEventListener('change', (event) => {
            preferModal = event.matches;
            if (!preferModal) {
              closeModal();
            }
          });
        }
        preferModal = modalQuery.matches;
      };

      updateModalPreference();

      const revealLeadCapture = () => {
        if (shouldUseModal()) {
          openModal();
          return;
        }
        shell.classList.add('is-expanded');
        shell.classList.remove('is-collapsed');
        shell.classList.remove('cta-visible');
        hideFloatingCtaButton();
        const firstField = form.querySelector('input, select, textarea');
        firstField?.focus();
        form.scrollIntoView({ behavior: 'smooth', block: 'center' });
      };

      closeControls.forEach((control) => {
        control.addEventListener('click', closeModal);
      });
      overlay?.addEventListener('click', closeModal);

      window.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closeModal();
        }
      });
      window.addEventListener('resize', updateModalPreference);

      function handleScrollReveal() {
        if (!deferDisplay || !floatingCta || !showFloatingCta) return;
        shell.classList.add('is-collapsed');

        const showCta = () => {
          const maxScroll = document.documentElement.scrollHeight - window.innerHeight;
          const progress = maxScroll <= 0 ? 1 : window.scrollY / maxScroll;
          if (progress >= SCROLL_THRESHOLD) {
            shell.classList.add('cta-visible');
            showFloatingCtaButton();
            window.removeEventListener('scroll', onScroll);
          }
        };

        let ticking = false;
        const onScroll = () => {
          if (ticking) return;
          ticking = true;
          requestAnimationFrame(() => {
            showCta();
            ticking = false;
          });
        };

        window.addEventListener('scroll', onScroll, { passive: true });
        setTimeout(showCta, 8000);

        floatingCta.addEventListener('click', revealLeadCapture);
      }

      handleScrollReveal();

      function attachAnchorReveal() {
        if (!shell.id) return;
        const inlineAnchors = Array.from(document.querySelectorAll(`a[href="#${shell.id}"]`));
        if (inlineAnchors.length === 0) return;

        inlineAnchors.forEach((anchor) => {
          anchor.addEventListener('click', (event) => {
            if (!shell.classList.contains('is-collapsed')) return;
            if (!deferDisplay || !showFloatingCta) return;
            event.preventDefault();
            revealLeadCapture();
          });
        });
      }

      attachAnchorReveal();

      if (isGlobalFallback) {
        const portalQueueKey = '__hoaLacLeadPortalQueue__';
        window.addEventListener('lead-form:request-open', openModal);
        window.addEventListener('lead-form:request-close', closeModal);

        window.__hoaLacLeadPortal = {
          open: () => openModal(),
          close: () => closeModal()
        };

        const queue = window[portalQueueKey];
        if (Array.isArray(queue) && queue.length > 0) {
          while (queue.length > 0) {
            const action = queue.shift();
            if (action === 'open') {
              openModal();
            } else if (action === 'close') {
              closeModal();
            }
          }
        }
        window[portalQueueKey] = [];
      }

      form.addEventListener('submit', (event) => {
        submitLead({
          event,
          form,
          setStatus,
          fieldErrors,
          sectionFlow,
          endpoint,
          leadTagInput,
          fallbackLeadTag,
          onSuccess: () => {
            if (shell.classList.contains('is-modal-open')) {
              setTimeout(() => closeModal(), 2000);
            }
          }
        });
      });
    }

    function createStatusSetter(statusEl) {
      const setter = (message = '', state = 'info') => {
        if (!statusEl) return;
        const text = message ?? '';
        statusEl.textContent = text;
        if (text) {
          statusEl.dataset.state = state;
        } else {
          statusEl.removeAttribute('data-state');
        }
        setter.currentMessage = text;
        setter.currentState = text ? state : undefined;
      };
      setter.currentMessage = statusEl?.textContent ?? '';
      setter.currentState = statusEl?.dataset?.state;
      return setter;
    }

    function handleAreaLimit(event, form, setStatus, fieldErrors) {
      const checkedAreas = form.querySelectorAll('input[name="areas"]:checked');
      if (checkedAreas.length > AREA_LIMIT) {
        event.target.checked = false;
        setStatus(`Chỉ chọn tối đa ${AREA_LIMIT} khu vực.`, 'error');
        fieldErrors?.set('areas', `Chỉ chọn tối đa ${AREA_LIMIT} khu vực.`);
        focusField(event.target);
        return;
      }
      if (typeof setStatus === 'function' && setStatus.currentMessage?.includes('Chỉ chọn tối đa')) {
        setStatus('');
      }
      fieldErrors?.clear('areas');
    }

    function getSelectedAreaLabels(form) {
      return Array.from(form.querySelectorAll('input[name="areas"]:checked'))
        .map((input) => input.nextElementSibling?.textContent?.trim())
        .filter((label) => Boolean(label));
    }

    function broadcastIntentChange(intentValue) {
      if (typeof window === 'undefined' || !intentValue) return;
      window.dispatchEvent(new CustomEvent('lead-intent-change', {
        detail: { intent: intentValue }
      }));
    }

    function broadcastAreasChange(labels) {
      if (typeof window === 'undefined') return;
      window.dispatchEvent(new CustomEvent('lead-areas-change', {
        detail: { areas: labels }
      }));
    }

    function setupValidationListeners(form, fieldErrors, setStatus) {
      if (!form) return;
      SECTION_FLOW.forEach((key) => {
        const group = form.querySelector(`[data-field-group="${key}"]`);
        if (!group) return;
        const inputs = group.querySelectorAll('input, select, textarea');
        inputs.forEach((input) => {
          const eventName = input.type === 'radio' || input.type === 'checkbox' ? 'change' : 'input';
          input.addEventListener(eventName, () => {
            const result = validateSection(key, form);
            if (result.valid) {
              fieldErrors?.clear(key);
              if (allSectionsValid(form) && setStatus?.currentState !== 'success') {
                setStatus?.('');
              }
            } else if (result.message) {
              fieldErrors?.set(key, result.message);
            }
          });
        });
      });

      form.addEventListener('reset', () => {
        fieldErrors?.clearAll();
      });
    }

    function serializeForm(formElement) {
      const formData = new FormData(formElement);
      const data = Object.fromEntries(formData);
      const selectedAreas = formData.getAll('areas');
      if (selectedAreas.length > 0) {
        data.areas = selectedAreas.join(', ');
      }
      return data;
    }

    function computeLeadTag({ intent, budgetRange, legalRisk, areas }) {
      let score = 0;
      score += intentWeights[intent] ?? 0;
      score += budgetWeights[budgetRange] ?? 0;
      score += legalWeights[legalRisk] ?? 0;
      if (areas?.some((area) => priorityAreas.includes(area))) {
        score += 1;
      }

      if (intent === 'luot_song' && legalRisk === 'co_the_rui_ro') {
        return 'lead_cold';
      }
      if (score >= 6) {
        return 'lead_hot';
      }
      if (score >= 3) {
        return 'lead_warm';
      }
      return 'lead_cold';
    }

    async function submitLead({ event, form, setStatus, fieldErrors, sectionFlow, endpoint, leadTagInput, fallbackLeadTag, onSuccess }) {
      event.preventDefault();
      if (!form) return;

      const validation = runSequentialValidation({ form, fieldErrors, setStatus });
      if (!validation.ok) {
        focusSection(validation.section, form);
        return;
      }

      const selectedAreaValues = Array.from(form.querySelectorAll('input[name="areas"]:checked')).map((input) => input.value);

      const now = new Date();
      const vnDateTime = now.toLocaleString('vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });

      const data = serializeForm(form);
      data.areas = selectedAreaValues.join(', ');
      const computedTag = computeLeadTag({
        intent: data.intent,
        budgetRange: data.budgetRange,
        legalRisk: data.legalRisk,
        areas: selectedAreaValues
      }) ?? fallbackLeadTag;
      data.leadTag = computedTag;
      if (typeof data.contact === 'string') {
        data.contact = data.contact.replace(/\s+/g, '').replace(/^0*/, (match) => (match ? '0' : ''));
      }
      if (leadTagInput) {
        leadTagInput.value = computedTag;
      }
      data.submittedAt = now.toISOString();
      data.submittedAtLocal = vnDateTime;

      if (data.company) {
        setStatus?.('Đã chặn spam.', 'warning');
        return;
      }

      if (!endpoint) {
        setStatus?.('Chưa cấu hình PUBLIC_LEAD_ENDPOINT.', 'error');
        return;
      }

      setStatus?.('Đang gửi...', 'info');
      try {
        const body = new URLSearchParams();
        Object.entries(data).forEach(([key, value]) => {
          body.append(key, typeof value === 'string' ? value : String(value ?? ''));
        });

        const response = await fetch(endpoint, {
          method: 'POST',
          body
        });

        if (response.ok) {
          let payloadMessage = 'Đã nhận thông tin!';
          try {
            const payload = await response.json();
            if (payload?.message) payloadMessage = payload.message;
          } catch (parseErr) {
            console.warn('Không parse được payload, dùng message mặc định.', parseErr);
          }
          setStatus?.(payloadMessage, 'success');
          form.reset();
          sectionFlow?.reset?.();
          fieldErrors?.clearAll();
          if (typeof onSuccess === 'function') {
            onSuccess();
          }
          return;
        }

        throw new Error(`Request failed with status ${response.status}`);
      } catch (error) {
        console.error(error);
        if (error instanceof TypeError) {
          setStatus?.('Đã nhận thông tin!', 'success');
          if (typeof onSuccess === 'function') {
            onSuccess();
          }
          form.reset();
          sectionFlow?.reset?.();
          fieldErrors?.clearAll();
        } else {
          setStatus?.('Không gửi được, vui lòng thử lại.', 'error');
        }
      }
    }

    function runSequentialValidation({ form, fieldErrors, setStatus }) {
      if (!form) {
        return { ok: false, section: undefined };
      }
      for (const key of SECTION_FLOW) {
        const result = validateSection(key, form);
        if (!result.valid) {
          if (result.message) {
            fieldErrors?.set(key, result.message);
            setStatus?.(result.message, 'error');
          }
          return { ok: false, section: key };
        }
        fieldErrors?.clear(key);
      }
      if (setStatus?.currentState !== 'success') {
        setStatus?.('');
      }
      return { ok: true };
    }

    function createFieldErrorRegistry(form) {
      const errorNodes = new Map();
      form.querySelectorAll('[data-error-for]').forEach((node) => {
        if (!(node instanceof HTMLElement)) return;
        const key = node.dataset.errorFor;
        if (!key) return;
        errorNodes.set(key, node);
        node.setAttribute('hidden', 'hidden');
      });

      const getGroup = (key) => form.querySelector(`[data-field-group="${key}"]`);

      const set = (key, message = '') => {
        if (!key) return;
        const node = errorNodes.get(key);
        const text = message?.trim() ?? '';
        if (node) {
          if (text) {
            node.textContent = text;
            node.removeAttribute('hidden');
          } else {
            node.textContent = '';
            node.setAttribute('hidden', 'hidden');
          }
        }
        const group = getGroup(key);
        if (group) {
          if (text) {
            group.classList.add('is-invalid');
          } else {
            group.classList.remove('is-invalid');
          }
        }
      };

      const clear = (key) => set(key, '');
      const clearAll = () => {
        errorNodes.forEach((_node, key) => {
          clear(key);
        });
      };

      return { set, clear, clearAll };
    }

    function focusField(field) {
      if (!field) return;
      requestAnimationFrame(() => {
        if (typeof field.scrollIntoView === 'function') {
          field.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
        }
        if (typeof field.focus === 'function') {
          field.focus({ preventScroll: true });
        }
      });
    }

    function getFieldErrorKey(field) {
      if (!field) return '';
      if (field.name) return field.name;
      if (field.dataset?.errorKey) return field.dataset.errorKey;
      const group = field.closest('[data-field-group]');
      return group instanceof HTMLElement ? group.dataset.fieldGroup ?? '' : '';
    }

    function setupSectionFlow(form, fieldErrors) {
      if (!form) return null;
      const completedSections = new Set();

      const handleProgress = (key) => {
        if (!isSectionComplete(key, form)) {
          completedSections.delete(key);
          return;
        }
        if (completedSections.has(key)) {
          return;
        }
        completedSections.add(key);
        fieldErrors?.clear(key);
        const nextKey = getNextSectionKey(key);
        if (nextKey) {
          focusSection(nextKey, form);
        } else {
          const submitButton = form.querySelector('button[type="submit"]');
          focusField(submitButton);
        }
      };

      SECTION_FLOW.forEach((key) => {
        const group = form.querySelector(`[data-field-group="${key}"]`);
        if (!group) return;
        const inputs = group.querySelectorAll('input, select, textarea');
        inputs.forEach((input) => {
          const eventName = input.type === 'radio' || input.type === 'checkbox' ? 'change' : 'input';
          input.addEventListener(eventName, () => handleProgress(key));
        });
      });

      return {
        reset: () => completedSections.clear()
      };
    }

    function isSectionComplete(key, form) {
      switch (key) {
        case 'intent':
        case 'budgetRange':
        case 'legalRisk':
          return Boolean(form.querySelector(`input[name="${key}"]:checked`));
        case 'areas':
          return form.querySelectorAll('input[name="areas"]:checked').length > 0;
        case 'contact': {
          const input = form.querySelector('input[name="contact"]');
          const value = input?.value?.trim() ?? '';
          return PHONE_PATTERN.test(value);
        }
        default:
          return true;
      }
    }

    function validateSection(key, form) {
      switch (key) {
        case 'intent': {
          const checked = form.querySelector('input[name="intent"]:checked');
          return checked ? { valid: true } : { valid: false, message: SECTION_MESSAGES.intent };
        }
        case 'budgetRange': {
          const checked = form.querySelector('input[name="budgetRange"]:checked');
          return checked ? { valid: true } : { valid: false, message: SECTION_MESSAGES.budgetRange };
        }
        case 'areas': {
          const checkedCount = form.querySelectorAll('input[name="areas"]:checked').length;
          if (checkedCount === 0) {
            return { valid: false, message: SECTION_MESSAGES.areas };
          }
          if (checkedCount > AREA_LIMIT) {
            return { valid: false, message: `Chỉ chọn tối đa ${AREA_LIMIT} khu vực.` };
          }
          return { valid: true };
        }
        case 'legalRisk': {
          const checked = form.querySelector('input[name="legalRisk"]:checked');
          return checked ? { valid: true } : { valid: false, message: SECTION_MESSAGES.legalRisk };
        }
        case 'contact': {
          const input = form.querySelector('input[name="contact"]');
          const value = input?.value?.trim() ?? '';
          if (!value) {
            return { valid: false, message: 'Vui lòng nhập số liên hệ.' };
          }
          if (!PHONE_PATTERN.test(value)) {
            return { valid: false, message: 'Số liên hệ phải đủ 10 số và bắt đầu bằng 03, 05, 07, 08, 09 hoặc 01[2|6|8|9].' };
          }
          return { valid: true };
        }
        default:
          return { valid: true };
      }
    }

    function focusSection(key, form) {
      if (!key || !form) return;
      const group = form.querySelector(`[data-field-group="${key}"]`);
      if (!group) return;
      const focusable = group.querySelector('input:not([type="hidden"]), select, textarea, button');
      if (focusable) {
        focusField(focusable);
      }
    }

    function getNextSectionKey(key) {
      const index = SECTION_FLOW.indexOf(key);
      if (index === -1) return undefined;
      return SECTION_FLOW[index + 1];
    }

    function allSectionsValid(form) {
      return SECTION_FLOW.every((key) => validateSection(key, form).valid);
    }

    function applySequentialTabIndex(form) {
      if (!form) return;
      const focusableSelectors = [
        'input:not([type="hidden"]):not(.hp)',
        'select',
        'textarea',
        'button'
      ].join(',');
      const focusables = Array.from(form.querySelectorAll(focusableSelectors));
      let order = 1;
      focusables.forEach((node) => {
        if (node instanceof HTMLInputElement || node instanceof HTMLSelectElement || node instanceof HTMLTextAreaElement || node instanceof HTMLButtonElement) {
          if (node.disabled || node.tabIndex < 0) {
            return;
          }
          node.tabIndex = order;
          order += 1;
        }
      });
    }
  })();
</script>
