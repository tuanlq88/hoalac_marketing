---
interface Props {
  headline?: string;
  description?: string;
  deferDisplay?: boolean;
}

const {
  headline = "Đánh giá mức phù hợp Hòa Lạc",
  description = "Trả lời 5 câu để đội ngũ gợi ý khu vực, pháp lý và room tài chính khớp với nhu cầu trong 24 giờ.",
  deferDisplay = true,
} = Astro.props;

const defaultLeadTag = import.meta.env.PUBLIC_DEFAULT_LEAD_TAG ?? "pending_classification";
const leadEndpoint = import.meta.env.PUBLIC_LEAD_ENDPOINT ?? "";
---
---
<section
  id="lead-form"
  style="background: #0f172a; color: #fff; padding: 3rem; border-radius: 1.5rem; margin-top: 3rem;"
  data-lead-shell
  data-defer={deferDisplay}
  data-endpoint={leadEndpoint}
>
  <div style="display: grid; gap: 2.5rem; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); align-items: center;">
    <div>
      <p class="tag" style="background: rgba(255,255,255,0.15); color: #fff;">Lead Qualification</p>
      <h2 style="margin: 1rem 0 0;">{headline}</h2>
      <p style="color: rgba(255,255,255,0.8);">{description}</p>
    </div>
    <form class="lead-form" data-lead-form>
      <fieldset class="field">
        <legend>Anh/chị quan tâm đất Hòa Lạc để:</legend>
        <div class="option-grid">
          <label class="option">
            <input type="radio" name="intent" value="o_thuc" required />
            <div class="option-text">
              <span>Ở thật</span>
            </div>
          </label>
          <label class="option">
            <input type="radio" name="intent" value="dau_tu_trung_han" required />
            <div class="option-text">
              <span>Đầu tư trung hạn</span>
            </div>
          </label>
          <label class="option">
            <input type="radio" name="intent" value="luot_song" required />
            <div class="option-text">
              <span>Lướt sóng</span>
            </div>
          </label>
        </div>
      </fieldset>
      <fieldset class="field">
        <legend>Tầm tài chính:</legend>
        <div class="option-grid">
          <label class="option">
            <input type="radio" name="budgetRange" value="&lt;1.5" required />
            <div class="option-text">
              <span>&lt; 1,5 tỷ</span>
            </div>
          </label>
          <label class="option">
            <input type="radio" name="budgetRange" value="1.5-2.5" required />
            <div class="option-text">
              <span>1,5 – 2,5 tỷ</span>
            </div>
          </label>
          <label class="option">
            <input type="radio" name="budgetRange" value="2.5-3.5" required />
            <div class="option-text">
              <span>2,5 – 3,5 tỷ</span>
            </div>
          </label>
          <label class="option">
            <input type="radio" name="budgetRange" value="&gt;3.5" required />
            <div class="option-text">
              <span>&gt; 3,5 tỷ</span>
            </div>
          </label>
        </div>
      </fieldset>
      <fieldset class="field">
        <legend>Khu vực anh/chị ưu tiên:</legend>
        <p class="hint">Chọn tối đa 2 khu vực (nếu cần).</p>
        <div class="option-grid" data-required-group="areas">
          <label class="option">
            <input type="checkbox" name="areas" value="gan_dhqg" />
            <div class="option-text">
              <span>Gần ĐHQG</span>
            </div>
          </label>
          <label class="option">
            <input type="checkbox" name="areas" value="gan_cnc" />
            <div class="option-text">
              <span>Gần khu CNC</span>
            </div>
          </label>
          <label class="option">
            <input type="checkbox" name="areas" value="binh_yen_thach_hoa" />
            <div class="option-text">
              <span>Bình Yên – Thạch Hòa</span>
            </div>
          </label>
          <label class="option">
            <input type="checkbox" name="areas" value="tien_xuan_yen_binh" />
            <div class="option-text">
              <span>Tiến Xuân – Yên Bình</span>
            </div>
          </label>
        </div>
      </fieldset>
      <fieldset class="field">
        <legend>Mức chấp nhận pháp lý:</legend>
        <div class="option-grid">
          <label class="option">
            <input type="radio" name="legalRisk" value="so_do_san" required />
            <div class="option-text">
              <span>Chỉ sổ đỏ</span>
              <small>Nhận đất ở ngay, pháp lý chuẩn</small>
            </div>
          </label>
          <label class="option">
            <input type="radio" name="legalRisk" value="cho_len_tho_cu" required />
            <div class="option-text">
              <span>Chờ lên thổ cư</span>
              <small>Chấp nhận 6–12 tháng làm thủ tục</small>
            </div>
          </label>
          <label class="option">
            <input type="radio" name="legalRisk" value="co_the_rui_ro" required />
            <div class="option-text">
              <span>Có thể rủi ro</span>
              <small>Chấp nhận đất vườn, quy hoạch chờ</small>
            </div>
          </label>
        </div>
      </fieldset>
      <div class="field">
        <label>Để lại Zalo / SĐT</label>
        <input
          type="tel"
          name="contact"
          required
          inputmode="tel"
          pattern="^(03|05|07|08|09|01[2689])[0-9]{8}$"
          placeholder="Zalo hoặc số điện thoại"
        />
      </div>
      <input type="hidden" name="source" value="hoa-lac-landing" />
      <input type="hidden" name="leadTag" value={defaultLeadTag} data-lead-tag />
      <input type="text" name="company" class="hp" tabindex="-1" autocomplete="off" />
      <button class="button" type="submit">Gửi yêu cầu</button>
      <p class="status" data-status></p>
    </form>
  </div>
  <button class="floating-cta" type="button" data-floating-cta aria-hidden="true">
    <span>Đánh giá mức phù hợp</span>
    <small>Trả lời 5 câu, nhận shortlist trong 24h</small>
  </button>
</section>

<style>
  .lead-form {
    background: #fff;
    color: var(--text);
    padding: 2rem;
    border-radius: 1.5rem;
    display: grid;
    gap: 1.25rem;
  }
  .lead-form .field {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }
  .lead-form fieldset {
    border: 1px solid rgba(15, 23, 42, 0.12);
    border-radius: 1rem;
    padding: 1rem 1.25rem;
    margin: 0;
  }
  .lead-form legend,
  .lead-form label {
    font-weight: 600;
  }
  .lead-form legend {
    margin-bottom: 0.5rem;
  }
  .option-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.75rem;
  }
  .option {
    border: 1px solid rgba(15, 23, 42, 0.16);
    border-radius: 0.9rem;
    padding: 0.75rem 0.9rem;
    display: flex;
    gap: 0.65rem;
    font-size: 0.95rem;
    cursor: pointer;
    background: #fff;
    align-items: flex-start;
  }
  .option input {
    margin-top: 0.15rem;
  }
  .option-text {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  .option-text span {
    font-weight: 600;
  }
  .option-text small {
    font-size: 0.8rem;
    color: var(--muted);
  }
  .hint {
    margin: 0 0 0.75rem;
    font-size: 0.85rem;
    color: var(--muted);
  }
  .lead-form input,
  .lead-form select,
  .lead-form textarea {
    border-radius: 0.75rem;
    border: 1px solid rgba(15, 23, 42, 0.16);
    padding: 0.9rem 1rem;
    font-size: 1rem;
    font-family: inherit;
  }
  .lead-form .hp {
    display: none;
  }
  .status {
    min-height: 1.2rem;
    color: var(--muted);
    font-size: 0.9rem;
  }
  [data-lead-shell] {
    position: relative;
  }
  [data-lead-shell].is-collapsed .lead-form {
    display: none;
  }
  .floating-cta {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    background: #f97316;
    color: #fff;
    border: none;
    border-radius: 999px;
    padding: 0.85rem 1.5rem;
    box-shadow: 0 20px 35px rgba(15, 23, 42, 0.25);
    display: none;
    flex-direction: column;
    gap: 0.15rem;
    font-weight: 600;
    cursor: pointer;
    z-index: 50;
    max-width: 260px;
    text-align: left;
  }
  .floating-cta small {
    font-size: 0.8rem;
    font-weight: 400;
  }
  [data-lead-shell].cta-visible .floating-cta {
    display: flex;
  }
  [data-lead-shell] .floating-cta[aria-hidden="true"] {
    display: none;
  }
  [data-lead-shell].is-expanded .floating-cta {
    display: none;
  }
</style>

<script type="module">
  const shell = document.querySelector('[data-lead-shell]');
  const form = shell?.querySelector('[data-lead-form]') ?? document.querySelector('[data-lead-form]');
  const status = shell?.querySelector('[data-status]') ?? document.querySelector('[data-status]');
  const floatingCta = shell?.querySelector('[data-floating-cta]') ?? document.querySelector('[data-floating-cta]');
  const endpoint = shell?.dataset.endpoint ?? '';
  const AREA_LIMIT = 2;
  const SCROLL_THRESHOLD = 0.65;
  const deferDisplay = shell?.dataset.defer === 'true';
  const leadTagInput = document.querySelector('[data-lead-tag]');
  const fallbackLeadTag = leadTagInput?.value ?? 'pending_classification';

  const areaCheckboxes = form?.querySelectorAll('input[name="areas"]') ?? [];

  const intentWeights = {
    o_thuc: 3,
    dau_tu_trung_han: 2,
    luot_song: 0
  };
  const budgetWeights = {
    '<1.5': 0,
    '1.5-2.5': 1,
    '2.5-3.5': 2,
    '>3.5': 3
  };
  const legalWeights = {
    so_do_san: 3,
    cho_len_tho_cu: 1,
    co_the_rui_ro: 0
  };
  const priorityAreas = ['gan_dhqg', 'gan_cnc'];

  function setCustomMessages() {
    if (!form) return;
    const REQUIRED_TEXT = 'Vui lòng điền thông tin này.';
    const PHONE_TEXT = 'Số liên hệ phải đủ 10 số và bắt đầu bằng 03, 05, 07, 08, 09 hoặc 01[2|6|8|9].';

    form.addEventListener('invalid', (event) => {
      const field = event.target;
      if (!(field instanceof HTMLInputElement || field instanceof HTMLTextAreaElement || field instanceof HTMLSelectElement)) {
        return;
      }
      if (field.validity.valueMissing) {
        field.setCustomValidity(REQUIRED_TEXT);
      } else if (field.type === 'tel' && field.validity.patternMismatch) {
        field.setCustomValidity(PHONE_TEXT);
      } else {
        field.setCustomValidity('');
      }
    }, true);

    form.addEventListener('input', (event) => {
      const field = event.target;
      if (field instanceof HTMLInputElement || field instanceof HTMLTextAreaElement || field instanceof HTMLSelectElement) {
        field.setCustomValidity('');
      }
    });
  }

  function computeLeadTag({ intent, budgetRange, legalRisk, areas }) {
    let score = 0;
    score += intentWeights[intent] ?? 0;
    score += budgetWeights[budgetRange] ?? 0;
    score += legalWeights[legalRisk] ?? 0;
    if (areas?.some((area) => priorityAreas.includes(area))) {
      score += 1;
    }

    if (intent === 'luot_song' && legalRisk === 'co_the_rui_ro') {
      return 'lead_cold';
    }
    if (score >= 6) {
      return 'lead_hot';
    }
    if (score >= 3) {
      return 'lead_warm';
    }
    return 'lead_cold';
  }

  function serializeForm(formElement) {
    const formData = new FormData(formElement);
    const data = Object.fromEntries(formData);
    const selectedAreas = formData.getAll('areas');
    if (selectedAreas.length > 0) {
      data.areas = selectedAreas.join(', ');
    }
    return data;
  }

  function handleAreaLimit(event) {
    if (!form) return;
    const checkedAreas = form.querySelectorAll('input[name="areas"]:checked');
    if (checkedAreas.length > AREA_LIMIT) {
      event.target.checked = false;
      if (status) {
        status.textContent = `Chỉ chọn tối đa ${AREA_LIMIT} khu vực.`;
      }
    }
  }

  areaCheckboxes.forEach((checkbox) => {
    checkbox.addEventListener('change', handleAreaLimit);
  });

  setCustomMessages();

  function handleScrollReveal() {
    if (!deferDisplay || !shell || !floatingCta) return;
    shell.classList.add('is-collapsed');

    const showCta = () => {
      if (!shell || !floatingCta) return;
      const maxScroll = document.documentElement.scrollHeight - window.innerHeight;
      const progress = maxScroll <= 0 ? 1 : window.scrollY / maxScroll;
      if (progress >= SCROLL_THRESHOLD) {
        shell.classList.add('cta-visible');
        floatingCta.removeAttribute('aria-hidden');
        window.removeEventListener('scroll', onScroll);
      }
    };

    let ticking = false;
    const onScroll = () => {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(() => {
        showCta();
        ticking = false;
      });
    };

    window.addEventListener('scroll', onScroll, { passive: true });
    setTimeout(showCta, 8000);

    const expandForm = () => {
      if (!shell) return;
      shell.classList.add('is-expanded');
      shell.classList.remove('is-collapsed');
      shell.classList.remove('cta-visible');
      floatingCta?.setAttribute('aria-hidden', 'true');
      const firstField = form?.querySelector('input, select, textarea');
      firstField?.focus();
      form?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

    floatingCta?.addEventListener('click', expandForm);
  }

  handleScrollReveal();

  async function submitLead(event) {
    event.preventDefault();
    if (!form || !status) return;
    if (!form.reportValidity()) {
      return;
    }

    const selectedAreaNodes = form.querySelectorAll('input[name="areas"]:checked');
    if (selectedAreaNodes.length === 0) {
      status.textContent = "Vui lòng chọn ít nhất 1 khu vực ưu tiên.";
      return;
    }
    const selectedAreaValues = Array.from(selectedAreaNodes).map((input) => input.value);

    const now = new Date();
    const vnDateTime = now.toLocaleString('vi-VN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    });

    const data = serializeForm(form);
    data.areas = selectedAreaValues.join(', ');
    const computedTag = computeLeadTag({
      intent: data.intent,
      budgetRange: data.budgetRange,
      legalRisk: data.legalRisk,
      areas: selectedAreaValues
    }) ?? fallbackLeadTag;
    data.leadTag = computedTag;
    if (typeof data.contact === 'string') {
      data.contact = data.contact.replace(/\s+/g, '').replace(/^0*/, (match) => (match ? '0' : ''));
    }
    if (leadTagInput) {
      leadTagInput.value = computedTag;
    }
    data.submittedAt = now.toISOString();
    data.submittedAtLocal = vnDateTime;

    if (data.company) {
      status.textContent = "Đã chặn spam.";
      return;
    }

    if (!endpoint) {
      status.textContent = "Chưa cấu hình PUBLIC_LEAD_ENDPOINT.";
      return;
    }

    status.textContent = "Đang gửi...";
    try {
      const body = new URLSearchParams();
      Object.entries(data).forEach(([key, value]) => {
        body.append(key, typeof value === 'string' ? value : String(value ?? ''));
      });

      const response = await fetch(endpoint, {
        method: 'POST',
        body
      });

      if (response.ok) {
        let payloadMessage = 'Đã nhận thông tin!';
        try {
          const payload = await response.json();
          if (payload?.message) payloadMessage = payload.message;
        } catch (parseErr) {
          console.warn('Không parse được payload, dùng message mặc định.', parseErr);
        }
        status.textContent = payloadMessage;
        form.reset();
        return;
      }

      throw new Error(`Request failed with status ${response.status}`);
    } catch (error) {
      console.error(error);
      if (error instanceof TypeError) {
        status.textContent = 'Đã nhận thông tin!';
        form.reset();
      } else {
        status.textContent = "Không gửi được, vui lòng thử lại.";
      }
    }
  }

  form?.addEventListener('submit', submitLead);
</script>
