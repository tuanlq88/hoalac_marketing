---
interface Props {
  headline?: string;
  description?: string;
}

const {
  headline = "Nhận bản tin chuyên sâu",
  description = "Chúng tôi phân loại lead theo hành trình mua để bạn phản hồi đúng tệp chỉ trong vài phút.",
} = Astro.props;

const defaultLeadTag = import.meta.env.PUBLIC_DEFAULT_LEAD_TAG ?? "pending_classification";
---
---
<section id="lead-form" style="background: #0f172a; color: #fff; padding: 3rem; border-radius: 1.5rem; margin-top: 3rem;">
  <div style="display: grid; gap: 2.5rem; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); align-items: center;">
    <div>
      <p class="tag" style="background: rgba(255,255,255,0.15); color: #fff;">Funnel Automation</p>
      <h2 style="margin: 1rem 0 0;">{headline}</h2>
      <p style="color: rgba(255,255,255,0.8);">{description}</p>
      <ul style="padding-left: 1.2rem; color: rgba(255,255,255,0.8); line-height: 1.6;">
        <li>Tự động ghi Google Sheet + tag lead nóng/ấm/lạnh</li>
        <li>Ping Telegram/Zalo OA khi xuất hiện lead nóng</li>
        <li>Biểu đồ mức độ quan tâm ngay trên dashboard</li>
      </ul>
    </div>
    <form class="lead-form" data-lead-form>
      <div class="field">
        <label>Họ và tên</label>
        <input type="text" name="fullName" required placeholder="Nguyễn Văn A" />
      </div>
      <div class="field">
        <label>Số điện thoại</label>
        <input
          type="tel"
          name="phone"
          required
          inputmode="tel"
          pattern="[0-9\s+()-]{8,15}"
          placeholder="09xx xxx xxx"
        />
      </div>
      <div class="field">
        <label>Email (tùy chọn)</label>
        <input type="email" name="email" placeholder="ban@domain.com" />
      </div>
      <div class="field">
        <label>Nhu cầu</label>
        <textarea name="note" rows="3" placeholder="Muốn săn đất gần tuyến metro, ngân sách 5-7 tỷ..."></textarea>
      </div>
      <div class="field">
        <label>Ngân sách dự kiến</label>
        <select name="budget" required>
          <option value="&lt;3">Dưới 3 tỷ</option>
          <option value="3-7">3 - 7 tỷ</option>
          <option value="&gt;7">Trên 7 tỷ</option>
        </select>
      </div>
      <input type="hidden" name="source" value="hoa-lac-landing" />
      <input type="hidden" name="leadTag" value={defaultLeadTag} data-lead-tag />
      <input type="text" name="company" class="hp" tabindex="-1" autocomplete="off" />
      <button class="button" type="submit">Gửi yêu cầu</button>
      <p class="status" data-status></p>
    </form>
  </div>
</section>

<style>
  .lead-form {
    background: #fff;
    color: var(--text);
    padding: 2rem;
    border-radius: 1.5rem;
    display: grid;
    gap: 1rem;
  }
  .lead-form .field {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }
  .lead-form label {
    font-weight: 600;
  }
  .lead-form input,
  .lead-form select,
  .lead-form textarea {
    border-radius: 0.75rem;
    border: 1px solid rgba(15, 23, 42, 0.16);
    padding: 0.9rem 1rem;
    font-size: 1rem;
    font-family: inherit;
  }
  .lead-form .hp {
    display: none;
  }
  .status {
    min-height: 1.2rem;
    color: var(--muted);
    font-size: 0.9rem;
  }
</style>

<script type="module">
  const form = document.querySelector('[data-lead-form]');
  const status = document.querySelector('[data-status]');
  const endpoint = import.meta.env.PUBLIC_LEAD_ENDPOINT;

  async function submitLead(event) {
    event.preventDefault();
    if (!form || !status) return;
    const data = Object.fromEntries(new FormData(form));

    if (data.company) {
      status.textContent = "Đã chặn spam.";
      return;
    }

    if (!endpoint) {
      status.textContent = "Chưa cấu hình PUBLIC_LEAD_ENDPOINT.";
      return;
    }

    status.textContent = "Đang gửi...";
    try {
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          ...data,
          submittedAt: new Date().toISOString(),
        })
      });

      if (!response.ok) {
        throw new Error('Request failed');
      }

      const payload = await response.json();
      status.textContent = payload.message ?? 'Đã nhận thông tin! Check inbox để xem báo cáo.';
      form.reset();
    } catch (error) {
      console.error(error);
      status.textContent = "Không gửi được, vui lòng thử lại.";
    }
  }

  form?.addEventListener('submit', submitLead);
</script>
