---
import Layout from "@components/Layout.astro";
import LeadForm from "@components/LeadForm.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const pillars = await getCollection('pillars');
  return pillars.map((pillar) => ({
    params: { slug: pillar.slug },
    props: { pillar }
  }));
}

const { pillar } = Astro.props;
const { Content, headings } = await pillar.render();
const tocEntries = (headings ?? []).filter((heading) => heading.depth === 2 || heading.depth === 3);
const hasToc = tocEntries.length > 0;

const [articles, posts] = await Promise.all([
  getCollection('articles'),
  getCollection('posts')
]);

const relatedTags = pillar.data.relatedTags ?? [];
const pillarSlug = pillar.slug;
const baseEnv = import.meta.env.BASE_URL ?? '/';
const basePath = baseEnv.endsWith('/') ? baseEnv.slice(0, -1) : baseEnv;

const relatedArticles = (relatedTags.length > 0
  ? articles.filter((article) => article.data.tags.some((tag) => relatedTags.includes(tag)))
  : articles
).sort((a, b) => (
  new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime()
));

const relatedPosts = posts
  .filter((post) => post.data.pillar === pillarSlug && !post.data.draft)
  .sort((a, b) => a.data.week_plan.localeCompare(b.data.week_plan))
  .reverse();

const MAX_RELATED_POSTS = 4;
const limitedRelatedPosts = relatedPosts.slice(0, MAX_RELATED_POSTS);

const getPostDateLabel = (post) => {
  const publishedAt = post.data.publishedAt ?? post.data.updatedAt;
  if (!publishedAt) return 'Đang cập nhật';
  const parsed = new Date(publishedAt);
  return Number.isNaN(parsed.getTime()) ? 'Đang cập nhật' : parsed.toLocaleDateString('vi-VN');
};

const formatWeekLabel = (weekPlan) => {
  if (!weekPlan) return 'Không rõ tuần';
  const match = /^([0-9]{4})w([0-9]{2})$/i.exec(weekPlan);
  if (!match) return `Tuần ${weekPlan}`;
  const [, year, week] = match;
  return `Tuần ${parseInt(week, 10)} · ${year}`;
};

const relatedPostGroups = limitedRelatedPosts.reduce((groups, post) => {
  const weekKey = post.data.week_plan ?? 'Chưa rõ';
  const existingGroup = groups.find((group) => group.weekKey === weekKey);
  if (existingGroup) {
    existingGroup.posts.push(post);
  } else {
    groups.push({ weekKey, posts: [post] });
  }
  return groups;
}, []);
---
<Layout title={pillar.data.title} description={pillar.data.excerpt}>
  <section class="pillar-shell">
    <header class="pillar-hero">
      <p class="pillar-eyebrow">Bài trung tâm · {pillar.data.stageFocus ?? pillar.data.priorityIntents.join(' / ')}</p>
      <h1>{pillar.data.title}</h1>
      <p class="pillar-lede">{pillar.data.excerpt}</p>
      <p class="pillar-meta">Cập nhật: {new Date(pillar.data.updatedAt).toLocaleDateString('vi-VN')}</p>
    </header>
    <div class="pillar-grid">
      <article class="pillar-body">
        <div class="pillar-reading">
          {hasToc && (
            <nav class="pillar-toc" aria-label="Mục lục trụ cột" data-pillar-toc>
              <button class="pillar-toc__toggle" type="button" data-pillar-toc-toggle>
                <span>Mục lục</span>
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M5 12h14M12 5l7 7-7 7" />
                </svg>
              </button>
              <div class="pillar-toc__panel" data-pillar-toc-panel>
                <p class="pillar-toc__title">Mục lục</p>
                <ol>
                  {tocEntries.map((heading) => (
                    <li class:list={[heading.depth === 3 && 'pillar-toc__item--nested']}>
                      <a href={`#${heading.slug}`} data-heading-id={heading.slug}>{heading.text}</a>
                    </li>
                  ))}
                </ol>
              </div>
            </nav>
          )}
          <div class="pillar-content">
            <Content />
          </div>
        </div>
      </article>
      <aside class="pillar-aside">
        {relatedArticles.length > 0 && (
          <div class="pillar-card">
            <p class="pillar-card-eyebrow">Bài blog liên quan</p>
            <ul>
              {relatedArticles.slice(0, 4).map((article) => (
                <li>
                  <a href={`${basePath}/blog/${article.slug}`}>{article.data.title}</a>
                  <span>{new Date(article.data.publishedAt).toLocaleDateString('vi-VN')}</span>
                </li>
              ))}
            </ul>
          </div>
        )}
        {relatedPostGroups.length > 0 && (
          <div class="pillar-card">
            <p class="pillar-card-eyebrow">Bài phân tích mới</p>
            <ul class="pillar-related-week-list">
              {relatedPostGroups.map((group) => (
                <li class="pillar-related-week">
                  <p class="pillar-related-week-label">{formatWeekLabel(group.weekKey)}</p>
                  <ul class="pillar-related-week-posts">
                    {group.posts.map((post) => (
                      <li>
                        <a class="pillar-related-link" href={`${basePath}/blog/${post.slug}`}>
                          <strong>{post.data.title}</strong>
                        </a>
                        <span class="pillar-related-date">{getPostDateLabel(post)}</span>
                      </li>
                    ))}
                  </ul>
                </li>
              ))}
            </ul>
          </div>
        )}
        <div class="pillar-card pillar-card--leadform">
          <p class="pillar-card-eyebrow">Cần tư vấn?</p>
          <LeadForm
            headline="Điền 5 câu để đội ngũ phản hồi 24h"
            description="Checklist cá nhân hóa theo khu vực ưu tiên và tiến độ quy hoạch mới nhất."
            deferDisplay={false}
          />
        </div>
      </aside>
    </div>
  </section>
</Layout>

<style>
  .pillar-shell {
    max-width: 1100px;
    margin: 3rem auto;
    padding: 0 1.5rem 4rem;
    --pillar-eyebrow: clamp(0.95rem, 0.88rem + 0.25vw, 1.18rem);
    --pillar-lede: clamp(1.35rem, 1.18rem + 0.5vw, 2rem);
    --pillar-meta: clamp(1.05rem, 0.92rem + 0.35vw, 1.35rem);
    --pillar-card-label: clamp(0.95rem, 0.82rem + 0.3vw, 1.2rem);
    --pillar-related-goal: clamp(1.15rem, 1.02rem + 0.35vw, 1.5rem);
  }

  .pillar-hero {
    margin-bottom: 2.5rem;
  }

  .pillar-eyebrow {
    font-size: var(--pillar-eyebrow);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--muted);
  }

  .pillar-lede {
    font-size: var(--pillar-lede);
    color: var(--muted);
    max-width: 720px;
  }

  .pillar-meta {
    margin-top: 0.75rem;
    font-size: var(--pillar-meta);
    color: var(--muted);
  }

  .pillar-grid {
    display: grid;
    grid-template-columns: minmax(0, 2fr) minmax(280px, 1fr);
    gap: 2.5rem;
  }

  .pillar-reading {
    position: relative;
  }

  .pillar-toc {
    display: none;
    --pillar-toc-top: clamp(6rem, calc(50vh - 200px), 12rem);
  }

  .pillar-toc__toggle {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    background: rgba(15, 23, 42, 0.08);
    border: none;
    border-radius: 999px;
    padding: 0.45rem 0.9rem;
    font-weight: 600;
    cursor: pointer;
    color: #0f172a;
    font-size: var(--font-small);
    transition: background 150ms ease;
  }

  .pillar-toc__toggle svg {
    width: 1rem;
    height: 1rem;
    stroke: currentColor;
    fill: none;
    stroke-width: 1.5;
    stroke-linecap: round;
    stroke-linejoin: round;
  }

  .pillar-toc__toggle:hover {
    background: rgba(15, 23, 42, 0.16);
  }

  .pillar-toc__panel {
    position: fixed;
    left: clamp(1rem, 3vw, 2rem);
    top: calc(var(--pillar-toc-top, clamp(6rem, calc(50vh - 200px), 12rem)) + 3.5rem);
    width: min(320px, 85vw);
    background: #fff;
    border-radius: 1rem;
    box-shadow: 0 35px 80px rgba(15, 23, 42, 0.25);
    padding: 1.2rem 1.4rem;
    border: 1px solid rgba(15, 23, 42, 0.08);
    display: none;
    flex-direction: column;
    gap: 0.5rem;
    max-height: min(70vh, calc(100vh - 8rem));
    overflow-y: auto;
    z-index: 45;
  }

  .pillar-toc[data-open="true"] .pillar-toc__panel {
    display: flex;
  }

  .pillar-toc__title {
    margin: 0;
    font-size: var(--pillar-eyebrow);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
  }

  .pillar-toc ol {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .pillar-toc li {
    font-size: var(--pillar-meta);
    line-height: 1.45;
  }

  .pillar-toc__item--nested {
    margin-left: 1rem;
  }

  .pillar-toc a {
    color: inherit;
    padding: 0.1rem 0.3rem;
    border-radius: 0.45rem;
    background-image: linear-gradient(120deg, rgba(249, 115, 22, 0.12), rgba(249, 115, 22, 0.18));
    background-size: 0% 100%;
    background-repeat: no-repeat;
    transition: color 150ms ease, background-size 200ms ease;
  }

  .pillar-toc a:hover,
  .pillar-toc a:focus-visible,
  .pillar-toc a.is-active {
    color: var(--accent-dark);
    background-size: 100% 100%;
  }

  .pillar-body :global(h2) {
    margin-top: 2.5rem;
  }

  .pillar-aside {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .pillar-card {
    padding: 1.5rem;
    border: 1px solid var(--shell-border, rgba(255, 255, 255, 0.08));
    border-radius: 1.25rem;
    background: var(--shell-bg, rgba(255, 255, 255, 0.02));
  }

  .pillar-card--leadform {
    padding: 1rem;
  }

  .pillar-card--leadform :global(.section-shell--lead) {
    padding: 0;
    background: transparent;
    box-shadow: none;
  }

  .pillar-card--leadform :global(.lead-shell) {
    max-width: none;
    margin: 0;
  }

  .pillar-card--leadform :global(.lead-card) {
    padding: clamp(1rem, 3vw, 1.5rem);
    background: #fff;
    border-radius: 1rem;
    border: 1px solid rgba(15, 23, 42, 0.08);
    box-shadow: none;
  }

  .pillar-card--leadform :global(.lead-copy) {
    text-align: left;
    margin-bottom: 0.85rem;
  }

  .pillar-card--leadform :global(.lead-form) {
    padding: 0.75rem 0.5rem 0.5rem;
  }

  .pillar-card-eyebrow {
    font-size: var(--pillar-eyebrow);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
    margin-bottom: 0.75rem;
  }

  .pillar-card ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .pillar-card li {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
  }

  .pillar-card a {
    color: inherit;
    font-weight: 600;
  }

  .pillar-card span {
    font-size: var(--pillar-card-label);
    color: var(--muted);
  }

  .pillar-card .tag {
    font-size: var(--font-label);
    font-weight: 600;
    color: var(--muted);
  }

  .pillar-related-week-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
  }

  .pillar-related-week {
    padding: 0.45rem 0;
    border-top: 1px solid rgba(15, 23, 42, 0.08);
  }

  .pillar-related-week:first-child {
    border-top: none;
  }

  .pillar-related-week-label {
    margin: 0 0 0.35rem;
    display: inline-flex;
    align-items: center;
    justify-content: left;
    padding: 0.15rem 0.5rem;
    border-radius: 999px;
    background: linear-gradient(120deg, rgba(249, 115, 22, 0.18), rgba(249, 115, 22, 0.32));
    width: 86%;
    font-size: var(--font-label);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #0f172a;
  }

  .pillar-related-week-posts {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.45rem;
  }

  .pillar-related-week-posts li {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
  }

  .pillar-related-link {
    color: inherit;
    text-decoration: none;
    padding: 0.1rem 0.25rem;
    border-radius: 0.45rem;
    background-image: linear-gradient(120deg, rgba(249, 115, 22, 0.12), rgba(249, 115, 22, 0.2));
    background-size: 0% 100%;
    background-repeat: no-repeat;
    transition: color 150ms ease, background-size 220ms ease;
  }

  .pillar-related-link:hover,
  .pillar-related-link:focus-visible {
    color: var(--accent-dark);
    background-size: 100% 100%;
    outline: none;
  }

  .pillar-related-date {
    font-size: var(--pillar-card-label);
    color: var(--muted);
  }

  @media (max-width: 960px) {
    .pillar-grid {
      grid-template-columns: 1fr;
    }
    .pillar-reading {
      flex-direction: column;
    }
  }

  @media (min-width: 768px) {
    .pillar-toc {
      display: block;
      position: fixed;
      left: clamp(1rem, 3vw, 2rem);
      top: var(--pillar-toc-top, clamp(6rem, calc(50vh - 200px), 12rem));
      z-index: 45;
    }
  }
</style>

<script type="module">
  const toc = document.querySelector('[data-pillar-toc]');
  if (toc) {
    const toggle = toc.querySelector('[data-pillar-toc-toggle]');
    const panel = toc.querySelector('[data-pillar-toc-panel]');
    const closePanel = () => toc?.setAttribute('data-open', 'false');
    toggle?.addEventListener('click', () => {
      const nextState = toc.getAttribute('data-open') === 'true' ? 'false' : 'true';
      toc.setAttribute('data-open', nextState);
    });

    const links = Array.from(toc.querySelectorAll('a[data-heading-id]'));
    const headingItems = links
      .map((link) => {
        const id = link.dataset.headingId;
        if (!id) return null;
        const heading = document.getElementById(id);
        if (!heading) return null;
        return { id, heading, link };
      })
      .filter(Boolean);

    const setActiveLink = (id) => {
      links.forEach((anchor) => {
        if (anchor.dataset.headingId === id) {
          anchor.classList.add('is-active');
        } else {
          anchor.classList.remove('is-active');
        }
      });
    };

    if (headingItems.length > 0) {
      const computeActiveHeading = () => {
        const offset = 140;
        let currentId = headingItems[0]?.id;
        for (const item of headingItems) {
          const { top } = item.heading.getBoundingClientRect();
          if (top - offset <= 0) {
            currentId = item.id;
          } else {
            break;
          }
        }
        if (currentId) {
          setActiveLink(currentId);
        }
      };

      let ticking = false;
      const handleScroll = () => {
        if (ticking) return;
        ticking = true;
        requestAnimationFrame(() => {
          computeActiveHeading();
          ticking = false;
        });
      };

      window.addEventListener('scroll', handleScroll, { passive: true });
      window.addEventListener('resize', handleScroll);
      computeActiveHeading();
      panel?.addEventListener('click', (event) => {
        const target = event.target;
        if (target instanceof HTMLElement && target.tagName === 'A') {
          closePanel();
        }
      });
    }
  }
</script>
